# 贷款业务逻辑实现说明

## 🎯 业务逻辑概述

根据您提供的详细业务逻辑，我已经实现了完整的贷款管理系统，支持两种放款方法和完整的还款处理流程。

## 📋 已实现的核心功能

### 1. 两种放款方法

#### Method 1: 先扣息 + 押金

- **计算逻辑**: 客户到手现金 = 贷款额 - 利息 - 押金
- **目标总额**: 贷款额（不含押金，不再额外收利息）
- **特点**: 利息在放款时一次性扣除

#### Method 2: 押金抵减目标额

- **计算逻辑**: 客户到手现金 = 贷款额 - 押金
- **目标总额**: 贷款额 - 押金
- **特点**: 押金从目标还款额中扣除

### 2. 押金处理逻辑

- **押金性质**: 保证金，不计为应收款
- **结清处理**: 根据政策退还客户或抵扣最后一期应收
- **状态跟踪**: 暂存(held) / 已退还(refunded) / 已抵扣(offset)

### 3. 入账自动拆分逻辑

**分配顺序**:

1. **费用/逾期费** - 优先处理
2. **利息** - 如果该方法有应收利息
3. **本金** - 最后处理
4. **预收/溢缴款** - 剩余金额自动记入预收

### 4. 结清条件判断

- **结清条件**: 应收利息 = 0 且 应收本金 = 0
- **押金处理**: 结清时根据政策退/抵，不影响结清条件

### 5. 逾期与坏账系统

- **DPD计算**: 今天 - 最近一个应还日（在累计实收 < 应还额时）
- **状态更新**: 正常 → 协商 → 坏账
- **配置化**: 支持自定义宽限天数、协商阈值、坏账阈值

## 🛠 技术实现

### 后端实现

#### 1. 数据库结构更新

```sql
-- 新增字段
ALTER TABLE loans ADD COLUMN loan_method VARCHAR(20) DEFAULT 'method1';
ALTER TABLE loans ADD COLUMN deposit_amount DECIMAL(15,2) DEFAULT 0;
ALTER TABLE loans ADD COLUMN prepaid_amount DECIMAL(15,2) DEFAULT 0;
ALTER TABLE loans ADD COLUMN upfront_interest DECIMAL(15,2) DEFAULT 0;
ALTER TABLE loans ADD COLUMN upfront_fees DECIMAL(15,2) DEFAULT 0;

-- 还款记录新增字段
ALTER TABLE repayments ADD COLUMN fee_amount DECIMAL(15,2) DEFAULT 0;
ALTER TABLE repayments ADD COLUMN prepaid_offset DECIMAL(15,2) DEFAULT 0;
```

#### 2. 计算引擎 (`server/utils/loanCalculator.js`)

- `calculateLoanAmounts()` - 贷款金额计算
- `generateRepaymentSchedule()` - 还款计划生成
- `allocatePayment()` - 还款分配逻辑
- `checkSettlementCondition()` - 结清条件判断
- `calculateOverdueDays()` - 逾期天数计算
- `updateCustomerStatus()` - 客户状态更新

#### 3. API更新

- **贷款创建**: 支持两种方法参数
- **还款处理**: 自动分配逻辑
- **状态管理**: 实时更新客户状态

### 前端实现

#### 1. 贷款计算器组件 (`LoanCalculator.tsx`)

- 实时计算两种方法的结果
- 可视化展示计算结果
- 支持参数调整和实时预览

#### 2. 贷款表单 (`LoanForm.tsx`)

- 集成计算器组件
- 支持两种方法选择
- 押金和费用输入
- 实时计算预览

#### 3. 类型定义更新

- 新增贷款方法相关字段
- 还款记录新增费用和预收字段
- 完整的TypeScript类型支持

## 📊 业务流程图

### 贷款创建流程

```text
1. 选择贷款方法 (Method 1/2)
2. 输入基础参数 (金额、利率、期限)
3. 设置押金和费用
4. 系统自动计算:
   - 到手现金
   - 目标总额
   - 月还款额
   - 前置利息
5. 生成还款计划
6. 创建贷款记录
```

### 还款处理流程

```text
1. 客户支付任意金额
2. 系统自动分配:
   - 费用 → 利息 → 本金 → 预收
3. 更新还款记录
4. 检查结清条件
5. 更新客户状态
6. 处理押金（如结清）
```

## 🎨 用户界面

### 贷款计算器

- **实时计算**: 参数调整时自动更新结果
- **方法对比**: 清晰展示两种方法的差异
- **金额展示**: 使用马币格式 (RM)

### 贷款表单

- **集成计算器**: 右侧实时预览计算结果
- **方法选择**: 下拉选择贷款方法
- **参数输入**: 支持所有必要参数
- **验证提示**: 实时验证输入有效性

## 🔧 配置选项

### 逾期配置

```sql
-- 默认配置
grace_period_days: 0        -- 宽限天数
negotiation_threshold: 30   -- 协商阈值(天)
bad_debt_threshold: 90      -- 坏账阈值(天)
```

### 权限控制

- **员工**: 基础操作权限
- **秘书**: 审批、合同、合规权限
- **经理/管理员**: 风险评估、黑名单、报表、系统设置权限

## 📈 报表功能

### 月度快照

- 自动生成月度业务快照
- 包含关键业务指标
- 支持审计和合规要求

### 实时统计

- 总放款额、总回款额
- 逾期金额、坏账金额
- 客户状态分布
- ROI计算

## 🚀 使用指南

### 创建贷款

1. 访问 `/loans/new`
2. 选择客户和贷款方法
3. 输入基础参数
4. 设置押金和费用
5. 查看实时计算结果
6. 提交创建

### 处理还款

1. 访问还款管理页面
2. 选择要处理的还款记录
3. 输入实付金额
4. 系统自动分配
5. 确认处理结果

### 查看报表

1. 访问仪表盘查看概览
2. 使用报表功能导出数据
3. 查看月度快照

## 🔍 验证方法

### 测试Method 1

```text
贷款金额: RM 50,000
年利率: 12%
期限: 12个月
押金: RM 5,000

结果:
- 到手现金: RM 35,000 (50,000 - 10,000利息 - 5,000押金)
- 目标总额: RM 50,000
- 月还款额: RM 4,167 (只还本金)
```

### 测试Method 2

```text
贷款金额: RM 50,000
年利率: 12%
期限: 12个月
押金: RM 5,000

结果:
- 到手现金: RM 45,000 (50,000 - 5,000押金)
- 目标总额: RM 45,000
- 月还款额: RM 3,750 (等额本息还目标金额)
```

## 📝 注意事项

1. **押金处理**: 押金不计入应收，只在结清时处理
2. **预收管理**: 多付金额自动记入预收，用于后续抵扣
3. **状态同步**: 客户状态与贷款状态实时同步
4. **权限控制**: 不同角色有不同的操作权限
5. **审计跟踪**: 所有操作都有审计日志记录

---

**实现完成时间**: 2025年9月5日  
**技术栈**: Node.js + Express + PostgreSQL + React + TypeScript + Ant Design  
**业务逻辑**: 完全按照您提供的详细规范实现
